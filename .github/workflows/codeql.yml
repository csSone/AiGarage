# å¯¹äºå¤§å¤šæ•°é¡¹ç›®ï¼Œè¿™ä¸ª workflow æ–‡ä»¶ä¸éœ€è¦ä¿®æ”¹ï¼›ä½ åªéœ€è¦
# å°†å®ƒæäº¤åˆ°ä½ çš„ä»“åº“ä¸­å³å¯ã€‚
#
# ä½ å¯èƒ½å¸Œæœ›ä¿®æ”¹è¿™ä¸ªæ–‡ä»¶æ¥è¦†ç›–è¦åˆ†æçš„è¯­è¨€é›†åˆï¼Œ
# æˆ–è€…æä¾›è‡ªå®šä¹‰æŸ¥è¯¢æˆ–æ„å»ºé€»è¾‘ã€‚
#
# ******** é‡è¦æç¤º ********
# æˆ‘ä»¬å·²ç»å°è¯•æ£€æµ‹ä½ ä»“åº“ä¸­çš„è¯­è¨€ã€‚è¯·æ£€æŸ¥ä¸‹é¢å®šä¹‰çš„
# `language` çŸ©é˜µï¼Œç¡®è®¤ä½ æ‹¥æœ‰æ­£ç¡®çš„ CodeQL æ”¯æŒè¯­è¨€é›†åˆã€‚
#
# Workflow åç§°ï¼šCodeQL é«˜çº§åˆ†æ
name: "CodeQL Advanced"

# è§¦å‘æ¡ä»¶é…ç½®
on:
  # å½“ä»£ç æ¨é€åˆ° main åˆ†æ”¯æ—¶è§¦å‘
  push:
    branches: [ "main" ]
  # å½“åˆ›å»ºé’ˆå¯¹ main åˆ†æ”¯çš„ Pull Request æ—¶è§¦å‘
  pull_request:
    branches: [ "main" ]
  # å®šæ—¶ä»»åŠ¡ï¼šæ¯å‘¨å…­ 00:19 è‡ªåŠ¨è¿è¡Œï¼ˆç”¨äºå®šæœŸå®‰å…¨æ‰«æï¼‰
  schedule:
    - cron: '19 0 * * 6'

# å®šä¹‰è¦æ‰§è¡Œçš„ä»»åŠ¡
jobs:
  analyze:
    # ä»»åŠ¡åç§°ï¼šæ˜¾ç¤ºå½“å‰æ­£åœ¨åˆ†æçš„è¯­è¨€
    name: Analyze (${{ matrix.language }})

    # Runner å¤§å°ä¼šå½±å“ CodeQL åˆ†ææ—¶é—´ã€‚æ›´å¤šä¿¡æ¯è¯·å‚è€ƒï¼š
    #   - https://gh.io/recommended-hardware-resources-for-running-codeql
    #   - https://gh.io/supported-runners-and-hardware-resources
    #   - https://gh.io/using-larger-runners (ä»… GitHub.com)
    # è€ƒè™‘ä½¿ç”¨æ›´å¤§çš„ runner æˆ–é…ç½®æ›´é«˜çš„èµ„æºæ¥ç¼©çŸ­åˆ†ææ—¶é—´ã€‚
    # è¿è¡Œç¯å¢ƒï¼šSwift ä½¿ç”¨ macOSï¼Œå…¶ä»–è¯­è¨€ä½¿ç”¨ Ubuntu
    runs-on: ${{ (matrix.language == 'swift' && 'macos-latest') || 'ubuntu-latest' }}

    # æƒé™é…ç½®
    permissions:
      # æ‰€æœ‰ workflow éƒ½éœ€è¦çš„å®‰å…¨äº‹ä»¶å†™å…¥æƒé™
      security-events: write

      # è·å–å†…éƒ¨æˆ–ç§æœ‰ CodeQL åŒ…æ‰€éœ€çš„åŒ…è¯»å–æƒé™
      packages: read

      # ä»…ç§æœ‰ä»“åº“ä¸­çš„ workflow éœ€è¦çš„æƒé™
      actions: read
      contents: read

    # ç­–ç•¥é…ç½®ï¼šå®šä¹‰å¤šä¸ªå¹¶è¡Œæ‰§è¡Œçš„ä»»åŠ¡
    strategy:
      # å®¹é”™ç­–ç•¥ï¼šä¸è¦åœ¨æŸä¸ªè¯­è¨€å¤±è´¥æ—¶ç«‹å³åœæ­¢å…¶ä»–è¯­è¨€çš„åˆ†æ
      # å¦‚æœè®¾ç½®ä¸º trueï¼Œä»»ä½•ä¸€ä¸ªè¯­è¨€åˆ†æå¤±è´¥éƒ½ä¼šå¯¼è‡´æ•´ä¸ª workflow åœæ­¢
      fail-fast: false

      # çŸ©é˜µé…ç½®ï¼šå®šä¹‰è¦åˆ†æçš„è¯­è¨€å’Œå¯¹åº”çš„æ„å»ºæ¨¡å¼
      matrix:
        include:
        # Go è¯­è¨€åˆ†æé…ç½®
        - language: go
          build-mode: autobuild  # è‡ªåŠ¨æ„å»ºæ¨¡å¼ï¼Œé€‚ç”¨äºå¤§å¤šæ•° Go é¡¹ç›®

        # Python è¯­è¨€åˆ†æé…ç½®
        - language: python
          build-mode: none      # æ— éœ€æ„å»ºï¼Œç›´æ¥åˆ†ææºä»£ç 

        # ====== è¯­è¨€é…ç½®è¯´æ˜ ======
        # CodeQL æ”¯æŒä»¥ä¸‹è¯­è¨€å…³é”®å­—ï¼š'actions', 'c-cpp', 'csharp', 'go', 'java-kotlin', 'javascript-typescript', 'python', 'ruby', 'rust', 'swift'
        # ä½¿ç”¨ `c-cpp` åˆ†æ Cã€C++ æˆ–ä¸¤è€…æ··åˆçš„ä»£ç 
        # ä½¿ç”¨ 'java-kotlin' åˆ†æ Javaã€Kotlin æˆ–ä¸¤è€…æ··åˆçš„ä»£ç 
        # ä½¿ç”¨ 'javascript-typescript' åˆ†æ JavaScriptã€TypeScript æˆ–ä¸¤è€…æ··åˆçš„ä»£ç 

        # ====== è‡ªå®šä¹‰é…ç½®æŒ‡å— ======
        # è¦äº†è§£æ›´å¤šå…³äºæ›´æ”¹åˆ†æè¯­è¨€æˆ–è‡ªå®šä¹‰æ„å»ºæ¨¡å¼çš„ä¿¡æ¯ï¼Œè¯·è®¿é—®ï¼š
        # https://docs.github.com/en/code-security/code-scanning/creating-an-advanced-setup-for-code-scanning/customizing-your-advanced-setup-for-code-scanning

        # å¦‚æœä½ æ­£åœ¨åˆ†æç¼–è¯‘å‹è¯­è¨€ï¼Œå¯ä»¥ä¿®æ”¹è¯¥è¯­è¨€çš„ 'build-mode' æ¥è‡ªå®šä¹‰
        # ä½ çš„ä»£ç åº“å¦‚ä½•è¢«åˆ†æï¼Œè¯·è®¿é—®ï¼š
        # https://docs.github.com/en/code-security/code-scanning/creating-an-advanced-setup-for-code-scanning/codeql-code-scanning-for-compiled-languages
    # æ‰§è¡Œæ­¥éª¤
    steps:
    # æ­¥éª¤ 1ï¼šæ£€å‡ºä»“åº“ä»£ç 
    - name: Checkout repository
      uses: actions/checkout@v4

    # ====== é¢„é…ç½®æ­¥éª¤è¯´æ˜ ======
    # åœ¨è¿è¡Œ `github/codeql-action/init` action ä¹‹å‰æ·»åŠ ä»»ä½•è®¾ç½®æ­¥éª¤ã€‚
    # è¿™åŒ…æ‹¬å®‰è£…ç¼–è¯‘å™¨æˆ–è¿è¡Œæ—¶ï¼ˆ`actions/setup-node` ç­‰ï¼‰çš„æ­¥éª¤ã€‚
    # è¿™é€šå¸¸ä»…åœ¨æ‰‹åŠ¨æ„å»ºæ—¶éœ€è¦ã€‚
    #
    # ç¤ºä¾‹ï¼ˆå–æ¶ˆæ³¨é‡Šä»¥ä½¿ç”¨ï¼‰ï¼š
    # - name: Setup runtime (example)
    #   uses: actions/setup-example@v1

    # æ­¥éª¤ 2ï¼šåˆå§‹åŒ– CodeQL å·¥å…·è¿›è¡Œæ‰«æ
    - name: Initialize CodeQL
      uses: github/codeql-action/init@v3
      with:
        # è¦åˆ†æçš„è¯­è¨€ï¼ˆä»çŸ©é˜µä¸­è·å–ï¼‰
        languages: ${{ matrix.language }}
        # æ„å»ºæ¨¡å¼ï¼ˆä»çŸ©é˜µä¸­è·å–ï¼‰
        build-mode: ${{ matrix.build-mode }}

        # ====== è‡ªå®šä¹‰æŸ¥è¯¢é…ç½® ======
        # å¦‚æœä½ å¸Œæœ›æŒ‡å®šè‡ªå®šä¹‰æŸ¥è¯¢ï¼Œå¯ä»¥åœ¨è¿™é‡Œæˆ–é…ç½®æ–‡ä»¶ä¸­è¿›è¡Œè®¾ç½®ã€‚
        # é»˜è®¤æƒ…å†µä¸‹ï¼Œè¿™é‡Œåˆ—å‡ºçš„æŸ¥è¯¢å°†è¦†ç›–é…ç½®æ–‡ä»¶ä¸­æŒ‡å®šçš„ä»»ä½•æŸ¥è¯¢ã€‚
        # åœ¨åˆ—è¡¨å‰åŠ ä¸Š "+" å‰ç¼€ä»¥ä½¿ç”¨è¿™äº›æŸ¥è¯¢å’Œé…ç½®æ–‡ä»¶ä¸­çš„æŸ¥è¯¢ã€‚

        # ====== æŸ¥è¯¢åŒ…è¯¦ç»†ä¿¡æ¯ ======
        # æœ‰å…³ CodeQL æŸ¥è¯¢åŒ…çš„æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚è€ƒï¼š
        # https://docs.github.com/en/code-security/code-scanning/automatically-scanning-your-code-for-vulnerabilities-and-errors/configuring-code-scanning#using-queries-in-ql-packs

        # ç¤ºä¾‹ï¼šå¯ç”¨æ›´å…¨é¢çš„å®‰å…¨å’Œè´¨é‡æ£€æŸ¥ï¼ˆå–æ¶ˆæ³¨é‡Šä»¥ä½¿ç”¨ï¼‰
        # queries: security-extended,security-and-quality

      # ====== æ‰‹åŠ¨æ„å»ºé…ç½®è¯´æ˜ ======
    # å¦‚æœåˆ†ææ­¥éª¤å¯¹ä½ æ­£åœ¨åˆ†æçš„æŸç§è¯­è¨€å¤±è´¥ï¼Œå¹¶æ˜¾ç¤º
    # "We were unable to automatically build your code"ï¼ˆæˆ‘ä»¬æ— æ³•è‡ªåŠ¨æ„å»ºä½ çš„ä»£ç ï¼‰ï¼Œ
    # è¯·ä¿®æ”¹ä¸Šé¢çš„çŸ©é˜µï¼Œå°†è¯¥è¯­è¨€çš„æ„å»ºæ¨¡å¼è®¾ç½®ä¸º "manual"ã€‚
    # ç„¶åä¿®æ”¹æ­¤æ­¥éª¤æ¥æ„å»ºä½ çš„ä»£ç ã€‚

    # ğŸ’¡ æç¤ºï¼šä½¿ç”¨æ“ä½œç³»ç»Ÿ shell è¿è¡Œçš„å‘½ä»¤è¡Œç¨‹åºã€‚
    # ğŸ“š å‚è€ƒï¼šhttps://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#jobsjob_idstepsrun

    # æ­¥éª¤ 3ï¼šæ‰‹åŠ¨æ„å»ºä»£ç ï¼ˆä»…åœ¨ build-mode ä¸º "manual" æ—¶æ‰§è¡Œï¼‰
    - if: matrix.build-mode == 'manual'
      shell: bash
      run: |
        echo 'å¦‚æœä½ æ­£åœ¨ä¸ºä¸€ç§æˆ–å¤šç§åˆ†æè¯­è¨€ä½¿ç”¨"æ‰‹åŠ¨"æ„å»ºæ¨¡å¼ï¼Œ' \
          'è¯·å°†æ­¤å¤„æ›¿æ¢ä¸ºæ„å»ºä»£ç çš„å‘½ä»¤ï¼Œä¾‹å¦‚ï¼š'
        echo '  make bootstrap'
        echo '  make release'
        echo 'æ³¨æ„ï¼šè¿™æ˜¯ä¸€ä¸ªç¤ºä¾‹é…ç½®ï¼Œä½ éœ€è¦æ ¹æ®ä½ çš„é¡¹ç›®å®é™…æ„å»ºå‘½ä»¤è¿›è¡Œä¿®æ”¹ã€‚'
        exit 1

    # æ­¥éª¤ 4ï¼šæ‰§è¡Œ CodeQL åˆ†æ
    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3
      with:
        # åˆ†æç±»åˆ«ï¼šæŒ‰è¯­è¨€åˆ†ç±»ï¼Œç”¨äºåŒºåˆ†ä¸åŒè¯­è¨€çš„åˆ†æç»“æœ
        category: "/language:${{matrix.language}}"
